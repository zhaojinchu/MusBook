{% extends "_dashboard.html" %}
{% load widget_tweaks %}

{% block name %}Request a Lesson{% endblock %}

{% block content %}
<div class="container mx-auto" x-data="{ showModal: false }">
    <form method="post" class="mb-8">
        {% csrf_token %}
        
        <div class="flex flex-col gap-4 justify-center w-full">
            <!-- Teacher field -->
            <div class="w-full">
                {{ form.teacher.label_tag }}
                {% render_field form.teacher class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-purple-500" %}
                {% if form.teacher.errors %}
                    {% for error in form.teacher.errors %}
                        <p class="text-red-500 text-xs italic">{{ error }}</p>
                    {% endfor %}
                {% endif %}
            </div>

            <!-- Calendar container -->
            <div id="calendar-container" class="w-full">
                <div id="calendar"></div>
            </div>

            <!-- Other form fields -->
            {% for field in form %}
                {% if field.name != 'teacher' %}
                <div class="w-full">
                    {{ field.label_tag }}
                    {% render_field field class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-purple-500" %}
                    {% if field.errors %}
                        {% for error in field.errors %}
                            <p class="text-red-500 text-xs italic">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}

            <div class="pt-6">
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" @click.prevent="showModal = true">
                    Submit Lesson Request
                </button>
            </div>
        </div>

        <!-- Modal content -->
        <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full" x-show="showModal" x-cloak>
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Lesson Request</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">Are you sure you want to submit this lesson request?</p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button type="button" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 mr-2" @click="showModal = false">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-24">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

    
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendarContainer = document.getElementById('calendar-container');
    var teacherSelect = document.getElementById('teacher-select');

    if (!teacherSelect) {
        console.error('Teacher select element not found');
        return;
    }

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek'
        },
        events: [],
    });

    teacherSelect.addEventListener('change', function() {
        var teacherId = this.value;
        if (teacherId) {
            calendarContainer.style.display = 'block';
            calendar.render();
            fetch(`/get_teacher_schedule/${teacherId}/`)
                .then(response => response.json())
                .then(data => {
                    calendar.removeAllEvents();
                    calendar.addEventSource(data);
                })
                .catch(error => console.error('Error:', error));
        } else {
            calendarContainer.style.display = 'none';
            calendar.removeAllEvents();
        }
    });

    // Trigger change event if a teacher is pre-selected
    if (teacherSelect.value) {
        teacherSelect.dispatchEvent(new Event('change'));
    }
});
</script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
{% endblock %}